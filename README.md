# PICO_SAMPLE_CODE

## 1．概要
「Pico3 TypeC」を使用して、LTE通信を行い、SORACOMプラットフォーム（SORACOM BEAM）経由で
「AWS IoT」へと接続する

## 2．ソフトウェア構成
ESP32開発環境

|     contents     |         value           |
|:-----------------|:------------------------|
| Selected Board   | ESP32 Dev Module        |
| PSRAM            | Disabled                |
| Partition Scheme | default_16MB.csv        |
| CPU Frequency    | 80MHz                   |
| Flash Mode       | QIO                     |
| Flash Frequency  | 40MHz                   |
| Flash Size       | 4MB                     |
| Upload Speed     | 921600                  |
| Core Debug Level | None                    |

## 3．前提条件
### 3.1．Visual Studio CodeとGitHubのインストール
参考HP：https://breezegroup.co.jp/202102/vscode-github-windows/

## 4．サンプルコードのクローン
    ①「Git Bash」を開く
    ②ソースコードを保存したいディレクトリへカレントディレクトリを移動
    cd 「保存したいディレクトリ」
    ③下記コマンドを実行
    git clone https://github.com/Iefuji-Kohei/Pico_sample_code.git
    以上でサンプルコードのクローンは完了

## 5．Pico3にサンプルコードを実装
    ①Pico3とPCをUSBケーブルで接続
    ②「Visual Studio Code」を開く
    ③PlatformIOから以下をインストールする
    - bblanchon/ArduinoJson@^6.21.3
    ④画面下部の「→（PlatfomIO：Upload）」をクリック
    ⑤Uploadが完了したら、画面下部の「コンセントマーク（PlatfomIO：Serial Moniter）」をクリック
    ⑥IMSI：[*******************]が表示されるので、控えておく
    以上でPico3にサンプルコードを実装完了
## 5．「AWS IoT」の設定
AWS上にPico3を「モノ」として登録し、「ポリシー」に準じた権限を与える。

### 5.1.「モノ」の作成
    ①AWSコンソール画面の左上「サービス」から「AWS IoT」をクリック
    ②画面左メニューの中から、「管理」⇒「すべてのデバイス」⇒「モノ」をクリック
    ③画面右上の「モノを作成」をクリック
    ④「1つのモノを作成」を選択して、「次へ」をクリック
    ④任意の「モノの名前」を入力して、「次へ」をクリック
    ⑤「新しい証明書を自動生成（推奨）」を選択して、「次へ」をクリック
    ⑥ポリシーは後で作成するので、何も選択せずに画面右下の「モノを作成」をクリック
    ⑦証明書発光画面が表示されるので、下記をダウンロードする
    ・デバイス証明書
    ・パブリックキーファイル
    ・プライベートキーファイル
    ・AmazonルートCA1ファイル
    以上で、モノの作成は完了

### 5.2．「ポリシー」の作成   
    ①画面左メニューの中から、「管理」⇒「セキュリティ」⇒「ポリシー」をクリック
    ②画面右上の「ポリシーを作成」をクリック
    ③任意の「ポリシー名」を入力して、下表の「ポリシーステートメント」を追加する

|     ポリシー効果  |    ポリシーアクション     |   ポリシーリソース   |
|:------------------|:------------------------|---------------------|
| 許可              | iot:Connect             | *                   |
| 許可              | iot:Publish             | *                   |
| 許可              | iot:Receive             | *                   |
| 許可              | iot:Subscribe           | *                   |

    ④画面右下の「作成」をクリック
    以上で、ポリシーの作成は完了

### 5.3．「モノ」に「ポリシー」をアタッチ
    ①画面左メニューの中から、「管理」⇒「セキュリティ」⇒「証明書」をクリック
    ②ダウンロードしたデバイス証明書ファイル (xxxxxxxxxx-certificate..pem.crt) のファイル名の先頭 (xxxxxxxxxx の部分) をコピーして、「証明書を見つける」 に貼り付け。
    　作成した証明書が表示される
    ③作成した証明書にチェックを入れて、「アクション」⇒「ポリシーのアタッチ」をクリック
    ④タブから作成したポリシー名を選択して、「ポリシーをアタッチ」をクリック
    以上で、「モノ」に「ポリシー」をアタッチ完了

## 6．「SORACOM BEAM」の設定
　対応するSIM回線を「AWS IoT」へ接続できるように設定する

### 6.1．SIMグループの作成
    ①SORACOMコンソール画面左上の「メニュー」⇒「SIMグループ」をクリック
    ②「追加」をクリック
    ③「グループ名」を入力して、「グループ作成」をクリック
    ④「SORACOM Beam設定」を選択して、「設定を追加する」をクリック
    ⑤「MQTTエントリポイント」を選択
    ⑥「転送先」の「ホスト名」に作成した「AWS IoT」のエンドポイントを入力する
    (※）「AWS IoT」画面左メニュー下部にある「設定」をクリックすると、エンドポイントが表示される
    ⑦「ポート番号」に「8883」を入力する
    ⑧「証明書」を選択して、「認証情報を追加」をクリック
    ⑨「認証情報ID」に任意の名前を入力
    ⑩「秘密鍵（KEY)」にダウンロードしたプライベートキーファイル（****-private.pem.key）をコピー&ペースト
    ⑪「証明書（CERT）」にダウンロードしたデバイス証明書（***-certificate.pem.crt）をコピー&ペースト
    （※）テキストエディタで開いてコピー
    ⑫「CA証明局」にダウンロードしたAmazonルートCA1ファイル（AmazonRootCA1.pem）をコピー＆ペースト
    ⑬「登録」をクリック
    ⑭「保存」をクリック
    以上で、SIMグループの作成は完了

### 6.2．使用SIMをSIMグループに登録
    ①SORACOMコンソール画面左上の「メニュー」⇒「SIM管理」をクリック
    ②使用するSIMのチェックボックスをクリックして、「操作」⇒「所属グループ変更」をクリック
    （※）「5．Pico3にサンプルコードを実装」で控えた「IMSI」を検索ボックスに入れると使用SIMのみが表示される
    ③作成したSIMグループを選択して、「グループ変更」をクリック
    以上で、使用SIMをSIMグループに登録完了

## 7．動作テスト
### 7.1．Pico3の起動とシリアルターミナルの起動
    ①Pico3とPCをUSBケーブルで接続する
    ②「Visual Studio Code」を開いて、画面下部の「コンセントマーク（PlatfomIO：Serial Moniter）」をクリック
    ③「Subscribe Start」が表示されたら、Pico3がサブスクライブ（受信待ち）状態に遷移完了

### 7.2．AWSからMQTTサーバーに対して、サブスクライブ（受信状態に）する
    ①AWSコンソール画面の左上「サービス」から「AWS IoT」をクリック
    ②画面左メニューから「テスト」⇒「MQTTテストクライアント」をクリック
    ③「トピックをサブスクライブする」を選択して、「トピックのフィルター」に「pico/sample/pub」を入力
    ④「追加設定」⇒「サービスの品質」⇒「サービスの品質１」を選択して、「サブスクライブ」をクリック
    以上で、トピック「pico/sample/pub」に対してパブリッシュされたデータを確認することができる
### 7.3．AWSからMQTTサーバーに対して、メッセージをパブリッシュ（送信）する
    ①「トピックに公開する」を選択して、「トピック名」に「pico/sample/sub」を入力
    ②「追加設定」⇒「サービスの品質」⇒「サービスの品質１」を選択して、「発行」をクリック
    以上で、トピック「pico/sample/sub」に対して、下記メッセージがパブリッシュされる
    {
        "message": "AWS IoT コンソールからの挨拶"
    }

### 7.4．Pico3でAWSからのパブリッシュ情報が受信できたか確認する
    「Visual Studio Code」のシリアルモニターに下記が表示されていれば、パブリッシュを無事受信できている
    Subscribe Payload["{  "message": "AWS IoT コンソールからの挨拶"}"]

### 7.5．Pico3からのパブリッシュ（返事）をAWSで確認する
    「MQTTテストクライアント」の画面下部「サブスクリプション」に下記データが表示されていれば、無事Pico3からのパブリッシュをAWS側で受信できている
    {
        "message": "Pico3からの挨拶"
    }

## 8．最後に
    上記より、AWSとPico3とのやり取りができる。
